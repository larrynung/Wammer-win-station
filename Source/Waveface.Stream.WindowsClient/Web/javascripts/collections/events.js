(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["underscore","backbone","models/event","localstorage","eventbundler"],function(e,n,r,i,s){var o;return o=function(o){function u(){return u.__super__.constructor.apply(this,arguments)}return t(u,o),u.prototype.model=r,u.prototype.schemaName="posts",u.prototype.dateGroup=[],u.prototype.localStorage=new i("events"),u.prototype.initialize=function(){return dispatch.on("store:change:posts:all",this.updatePost,this),dispatch.on("more:posts",this.loadMore,this)},u.prototype.updatePost=function(t,r){var s,o,u,a=this;u=t.posts,o=!1;if(u.length<=0)return!1;e.each(u,function(e,t){var n;return n=moment(e.timestamp).format("YYYY-MM-DD"),t===0&&(o=n),a.dateGroup.push(n),a.add(e)}),this.dateGroup=e.uniq(this.dateGroup),s=new i("nc_view_state:events");if(s.data.date!=null)return n.history.navigate("events/"+s.data.date,{trigger:!0});if(r==="all")return n.history.navigate("events/"+o,{trigger:!0})},u.prototype.loadMore=function(){return this.callPosts("more",this.updatePost,this)},u.prototype.callPosts=function(e,t,n){var r,o,u,a,f;return e==null&&(e="all"),new s("GetPosts",e),!!t&&!!n&&(dispatch.off("store:change:posts:"+e),dispatch.on("store:change:posts:"+e,t,n)),r=new i("nc_events_view_data"),f=r.data,f.pageNo?u=f.pageNo+=1:u=f.pageNo=1,r.data=f,r.save(),o={namespace:e},a={page_no:u,page_size:30},wfwsocket.sendMessage("getPosts",a,o)},u.prototype.filterByDate=function(t){return t?e(this.filter(function(e){var n;return n=e.get("dateUri"),n===t})):this},u.prototype.nextDate=function(t){var n;return n=e.indexOf(this.dateGroup,t),this.dateGroup[n-1]},u.prototype.previousDate=function(t,n){var r;return n==null&&(n=!0),r=e.indexOf(this.dateGroup,t),n===!0&&(this.dateGroup[r+3]||dispatch.trigger("more:posts")),this.dateGroup[r+1]},u.prototype.nextEvent=function(e){var t;return t=this.indexOf(this.get(e)),this.at(t-1)},u.prototype.previousEvent=function(e){var t;return t=this.indexOf(this.get(e)),this.at(t+1)},u}(n.Collection),new o})}).call(this);