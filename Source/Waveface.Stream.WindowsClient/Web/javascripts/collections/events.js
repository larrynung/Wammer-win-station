(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["underscore","backbone","models/event","localstorage","eventbundler","com/subscriber"],function(e,n,r,i,s,o){var u,a,f;return a=o.POST_ADDED,f=o.POST_UPDATE,u=function(u){function l(){return l.__super__.constructor.apply(this,arguments)}return t(l,u),l.prototype.model=r,l.prototype.schemaName="posts",l.prototype.dateGroup=[],l.prototype.localStorage=new i("events"),l.prototype.initialize=function(){return dispatch.on("store:change:posts:all",this.updatePost,this),dispatch.on("subscribe:change:"+a+":new:event",this.updatePost,this),dispatch.on("subscribe:change:"+f+":update:event",this.updatePost,this),dispatch.on("more:posts",this.loadMore,this)},l.prototype.comparator=function(e){return-moment(e.get("timestamp")).unix()},l.prototype.updatePost=function(t,r){var s,o,u,a,f=this;a=t.posts,u=!1;if(a.length<=0)return!1;e.each(a,function(e,t){var n;return n=moment(e.timestamp).format("YYYY-MM-DD"),t===0&&(u=n),f.dateGroup.push(n),f.add(e)}),this.dateGroup=e.uniq(this.dateGroup),this.dateGroup.sort(),this.dateGroup.reverse(),s=new i("nc_view_state:events"),s.data.date!=null?s.data.id!=null?o="events/"+s.data.date+"/"+s.data.id:o="events/"+s.data.date:r==="all"&&(o="events/"+u);if(o!=null)return n.history.navigate(o,{trigger:!0})},l.prototype.loadMore=function(){return this.callPosts("more",this.updatePost,this)},l.prototype.callPosts=function(e,t,n){var r,o,u,a,f;return e==null&&(e="all"),new s("GetPosts",e),!!t&&!!n&&(dispatch.off("store:change:posts:"+e),dispatch.on("store:change:posts:"+e,t,n)),r=new i("nc_events_view_data"),f=r.data,f.pageNo?u=f.pageNo+=1:u=f.pageNo=1,r.data=f,r.save(),o={namespace:e,type:this.schemaName},a={page_no:u,page_size:30},wfwsocket.sendMessage("getPosts",a,o)},l.prototype.subscribe=function(e,t,n,r){var i,u;return e==null&&(e="new:event"),r==null&&(r=o.POST_ADDED),new s("SubscribeEvent",e),u={event_id:r},i={namespace:e,event_id:r},wfwsocket.sendMessage("subscribeEvent",u,i)},l.prototype.filterByDate=function(t){return t?e(this.filter(function(e){var n;return n=e.get("dateUri"),n===t})):this},l.prototype.nextDate=function(t){var n;return n=e.indexOf(this.dateGroup,t),this.dateGroup[n-1]},l.prototype.previousDate=function(t,n){var r;return n==null&&(n=!0),r=e.indexOf(this.dateGroup,t),n===!0&&(this.dateGroup[r+3]||dispatch.trigger("more:posts")),this.dateGroup[r+1]},l.prototype.nextEvent=function(e){var t;return t=this.indexOf(this.get(e)),this.at(t-1)},l.prototype.previousEvent=function(e){var t;return t=this.indexOf(this.get(e)),this.at(t+1)},l}(n.Collection),new u})}).call(this);