(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["underscore","views/layouts/day_view","mustache","mousetrap","views/partials/event_sum","views/partials/event_detail","collections/events","models/event","text!templates/events.html","localstorage","com/subscriber"],function(e,n,r,i,s,o,u,a,f,l,c){var h,p,d;return p=c.POST_ADDED,d=c.POST_UPDATE,h=function(n){function u(){return u.__super__.constructor.apply(this,arguments)}return t(u,n),u.prototype.id="events",u.prototype.eventView=[],u.prototype.initialize=function(){return dispatch.on("subscribe:change:"+p+":new:event",this.updateEventMenu,this),dispatch.on("subscribe:change:"+d+":update:event",this.checkEventUpdate,this)},u.prototype.render=function(e,t){var n,i,s=this;return this.mode="event",this.date=e,t!=null&&(i=this.collection.get(t),i!=null&&(this.currentEvent=i,this.date=this.currentEvent.get("dateUri"))),this.setDates(),n={currentDate:this.currentDate,nextDate:this.nextDate,previousDate:this.previousDate},this.$el.html(r.render(f,n)),this.collection.filterByDate(this.date).each(function(e,t){return s.addOne(e,t)}),this.delegateEvents(),this.setHeaderStyle(),this.setKey(),i!=null&&this.eventSelect(i),this},u.prototype.addOne=function(e,t,n){n==null&&(n=!1),this.eventView[e.id]=new s({model:e}),this.eventView[e.id].on("eventSelect",this.eventSelect,this),n?this.$("#events-left").prepend(this.eventView[e.id].render().el):this.$("#events-left").append(this.eventView[e.id].render().el);if(t===0)return this.eventSelect(e)},u.prototype.updateEventMenu=function(t,n){var r,i=this;return r=t.posts,r.length<=0?!1:(n==="new:event"&&e.each(r,function(e){var t;return t=new a(e),t.get("dateUri")===i.date?i.addOne(t,1,!0):i.render(i.date,i.currentEvent.get("id"))}),!0)},u.prototype.eventSelect=function(e){return e?this.renderCurrentEvent(e):!1},u.prototype.renderCurrentEvent=function(e){var t,n;return this.currentEvent=e||this.currentEvent,this.currentEvent?(this.eventDetailView!=null&&(this.eventDetailView.remove(),this.eventDetailView.model.off()),this.eventDetailView=new o({model:this.currentEvent}),this.eventDetailView.render(),t=this,this.$("#events-right").fadeIn(200,function(){return $(this).empty().append(t.eventDetailView.el),$(this).fadeIn("fast",function(){return t.eventDetailView.renderMap()})}),this.$(".event").removeClass("selected"),this.eventView[this.currentEvent.id].$el.addClass("selected"),n=new l("nc_view_state:events"),n.data={date:this.date,id:this.currentEvent.id},n.save(),Router.navigate("events/"+this.date+"/"+this.currentEvent.id)):!1},u.prototype.checkEventUpdate=function(t){var n,r=this;return this.currentEvent?(n=t.posts,e.each(n,function(e){if(r.currentEvent.id===e.id)return r.renderCurrentEvent()})):!1},u.prototype.nextEvent=function(){var e;e=this.collection.nextEvent(this.currentEvent.id);if(!e)return!1;if(e.get("dateUri")===this.date)return this.eventSelect(e)},u.prototype.previousEvent=function(){var e;e=this.collection.previousEvent(this.currentEvent.id);if(!e)return!1;if(e.get("dateUri")===this.date)return this.eventSelect(e)},u.prototype.calendarSwitch=function(){var t,n,r=this;if(this.mode==="calendar")return this.render(this.date);if(this.mode==="event")return n=this.collection.map(function(e){return{start:e.get("dateUri"),title:"Events",allDay:!0,backgroundColor:"#C85E52",borderColor:"#C85E52"}}),n=e.uniq(n,!1,function(e){return e.start}),t={events:n,year:this.currentYear,month:this.currentMonth,header:!1,height:$("#main").height()-100,eventClick:function(e){return Router.navigate("events/"+moment(e.start).format("YYYY-MM-DD"),{trigger:!0})},viewDisplay:function(e){return r.updateHeaderDate(e.title)}},this.renderCalendar(t)},u.prototype.setKey=function(){var e=this;return i.reset(),i.bind("right",function(){return e.nextPage(),!1}),i.bind("left",function(){return e.previousPage(),!1}),i.bind("up",function(){return e.nextEvent(),!1}),i.bind("down",function(){return e.previousEvent(),!1}),i.bind("c",function(){return e.calendarSwitch(),!1})},u}(n),new h({collection:u})})}).call(this);